"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}(function(){var a="object"===("undefined"==typeof global?"undefined":_typeof(global)),c=a?global:"object"===("undefined"==typeof window?"undefined":_typeof(window))&&window,d=a?c.setImmediate:c.requestIdleCallback?c.requestIdleCallback:setTimeout,b=function(a){return"object"===_typeof(a)&&e(a.then)},e=function(a){return a instanceof Function},f=function(a){return"object"===_typeof(a)&&a.constructor===Object},g=function(a){return"string"==typeof a},h=function(a){return a instanceof RegExp},i=function(a,b){for(var c in b)Object.defineProperty(a,c,{value:b[c],enumerable:!1,configurable:!1});return a},j=function a(){var a={binds:new Map,bound:new Set,get:function(b,c){if(a.binds.has(b))return a.binds.get(b).get(c)},set:function(b,c,e,f){a.binds.has(b)||a.binds.set(b,new Map),a.bound.add(e),a.binds.get(b).set(c,e),f&&d(e)},delete:function(b,c){a.binds.has(b)&&(a.bound.delete(a.binds.get(b).get(c)),a.binds.get(b).delete(c),!a.binds.get(b).size&&a.binds.delete(b))},update:d.bind(null,function(){a.bound.forEach(function(a){return a()})}),clear:function(){a.bound.forEach(function(a){return a.revoke()}),a.bound.clear(),a.binds.forEach(function(a){return a.clear()}),a.clear()}};return a},k=function(a){var k=a.val,l=a.history,m=a.maxhistory,n=a.pre,o=a.prescreen,p=a.screen,q=a.mutate,r=a.fail,s=a.views,t=a.revoked;!0===l&&(l=[]);var u=!1,v=j(),w=function a(b,c,d,f){var h=g(d);if(h&&!(d in y))throw new Error("state.bind: cannot create bind to undefined view");var a;return a=e(c)?h?function(){return c(b,y[d])}:function(){return c(b,k)}:h?function(){b[c]=y[d]}:function(){b[c]=k},a.revoke=function(){v.delete(b,c),f&&f()},v.set(b,c,a,null!=k),a};w.input=function(a,b){var c=function(){a.value=k},d=function(){D(a.value.trim())};return a.addEventListener("input",d),c.revoke=function(){a.removeEventListener("input",d),v.delete(a,"value"),b&&b()},v.set(a,"value",c,null!=k),c};var x=function a(f,g,h){if(null!=f&&f.appendChild){var i=[f,void 0];g=i[0],f=i[1]}var a=new c.Text;g&&g.appendChild?d(function(){return g.appendChild(a)}):e(g)&&(h=g);var j=w(a,"textContent",f,function(){a.textContent="",h&&h();try{a.remove()}catch(a){}});return j.text=a,j},y=function(){return k},z=new Set,A=function(a,b){if(!e(b))throw new TypeError("a view should be a function");if(z.has(a))throw new Error("state: duplicate view");z.add(a),Object.defineProperty(y,a,{get:function(){return b(k)}}),x[a]=function(b,c,d){return x(a,b,c,d)}};if(f(s)){for(var B in s)A(B,s[B]);s=void 0}if(null!=p&&h(p)){var C=p;p=function(a){return g(a)&&C.test(a)}}var D=function a(c){if(!(u||c===k)){if(e(c)&&(c=c(k)),null==c)throw new Error("state.mutate: cannot create mutation from undefined");else if(e(c))throw new TypeError("state: cannot accept function values");if(b(c))return c.then(function(b){return a(b)},function(a){return r(c,a)});if(n&&(o||!o(c,k)?r(c,new Error("failed prescreen")):c=n(c,k)),p&&!p(c,k)){var d=new Error("failed screening");if(r)r(c,d);else throw d}else k=c,v.update(),l&&(l.push(k),null!=m&&l.length>m&&l.shift()),q&&q(k)}},E=i(function(a){return null!=a&&D(a),a},{bind:w,text:x,mutate:D,history:l,view:y,toJSON:y,createView:A,binds:v,revoke:function(){v.clear(),k=void 0,z.forEach(function(a){return delete y[a]}),z.clear(),u=!0,l&&(l.length=0),t&&t()}});return Object.freeze(E)};k.collection=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:Object.create(null);if(!f(a))throw new Error("stateCollection needs a model object");for(var b in a)f(a[b])&&(a[b]=k(a[b]));return i(a,{toObj:function(){return k.collection.toObj(a)},mutate:function(b,c){if(f(b))for(var d in b)a[d]&&a[d].mutate(b[d]);else null!=b&&null!=c&&a[b].mutate(c)},reactive:function b(){var b={},c=function(c){Object.defineProperty(b,c,{get:function(){return a[c].view()},set:function(b){return a[c].mutate(b)}})};for(var d in a)c(d);return b}})},k.collection.toObj=function(a){var b=Object.create(null);for(var c in a)b[c]=a[c].view();return b},"undefined"==typeof module?"function"==typeof i&&i.amd?i(["state"],function(){return k}):c.state=k:module.exports=k})();